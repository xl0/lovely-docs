## Overview

Run the OpenCode coding agent inside a Daytona sandbox using its web interface. The agent can develop web apps, write code in any language, install dependencies, run scripts, and supports 75+ LLM providers with live preview links.

## Workflow

1. Launch the main script to create a Daytona sandbox with OpenCode installed
2. Access the web interface via a preview link
3. Create and interact with agent sessions
4. Agent automatically generates preview links for hosted web apps
5. Press Ctrl+C to delete the sandbox automatically

## Setup

Clone the repository and navigate to the example:
```bash
git clone https://github.com/daytonaio/daytona.git
cd daytona/guides/typescript/opencode
```

Get your API key from the Daytona Dashboard and create `.env`:
```bash
DAYTONA_API_KEY=your_daytona_key
```

Requires Node.js 18+. Install and run:
```bash
npm install
npm run start
```

## Models and API Providers

OpenCode supports 75+ LLM providers with a free default. Change providers in the web interface menu. To persist API keys between runs, add them to the sandbox environment:

```typescript
sandbox = await daytona.create({
  envVars: {
    ANTHROPIC_API_KEY: process.env.ANTHROPIC_API_KEY || '',
  },
})
```

## Script Implementation

### Initialization Steps

1. Create a new Daytona sandbox
2. Install OpenCode globally via npm using process execution
3. Upload custom agent configuration with Daytona-specific system prompt
4. Start OpenCode web server on port 3000
5. Replace localhost URL with Daytona preview link

### Main Script Code

Execute OpenCode as an async command:
```typescript
const command = await sandbox.process.executeSessionCommand(sessionId, {
  command: `${envVar} opencode web --port ${OPENCODE_PORT}`,
  runAsync: true,
})
```

Parse OpenCode's output and replace localhost with preview link:
```typescript
const opencodePreviewLink = await sandbox.getPreviewLink(OPENCODE_PORT)
const replaceUrl = (text: string) =>
  text.replace(
    new RegExp(`http:\\/\\/127\\.0\\.0\\.1:${OPENCODE_PORT}`, 'g'),
    opencodePreviewLink.url
  )
```

### Agent Configuration

Custom system prompt passed as JSON via `OPENCODE_CONFIG_CONTENT` environment variable:

```json
{
  "$schema": "https://opencode.ai/config.json",
  "default_agent": "daytona",
  "agent": {
    "daytona": {
      "description": "Daytona sandbox-aware coding agent",
      "mode": "primary",
      "prompt": "You are running in a Daytona sandbox. Use the /home/daytona directory instead of /workspace for file operations. When running services on localhost, they will be accessible as: <PREVIEW_URL_PATTERN>. When starting a server, always give the user the preview URL to access it. When starting a server, start it in the background with & so the command does not block further instructions."
    }
  }
}
```

The `<PREVIEW_URL_PATTERN>` is a template URL with `{PORT}` placeholder, generated by creating a preview link and replacing the port number.

### Cleanup

Automatic sandbox deletion on Ctrl+C:
```typescript
process.once('SIGINT', async () => {
  console.log('\nCleaning up...')
  if (sandbox) await sandbox.delete()
  process.exit(0)
})
```

## Key Advantages

- Secure, isolated execution in Daytona sandboxes
- OpenCode Web interface accessible via browser
- Support for 75+ LLM providers
- All agent code execution happens inside the sandbox
- Automatic preview link generation for deployed services
- Custom agent configuration for Daytona-specific workflows
- Clean resource management with automatic sandbox cleanup